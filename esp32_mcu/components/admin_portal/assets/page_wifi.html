<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TapGate Â· WiFi</title>
  <link rel="stylesheet" href="/assets/styles.css">
  <script src="/api/initial-data.js"></script>
  <script defer src="/assets/app.js"></script>
</head>
<body class="page page-wifi">
  <main class="card">
    <h1>WiFi</h1>
    
    <div class="wifi-section">
      <h2>Current network</h2>
      <div class="network-card current-network" id="current-network">
        <div class="network-item">
          <img src="/assets/wifi3.svg" alt="WiFi" class="wifi-icon" id="current-wifi-icon">
          <span class="network-name" id="current-network-name">Not connected</span>
        </div>
      </div>
    </div>
    
    <div class="wifi-section">
      <h2>Available networks</h2>
      <div class="network-card available-networks">
        <div id="scan-status" class="scan-status">Scanning...</div>
        <div id="networks-list" class="networks-list" style="display: none;"></div>
        
        <!-- Add network as part of the list -->
        <div class="network-item add-network-item" id="add-network-btn">
          <div class="add-network-icon">+</div>
          <span class="network-name">Add network</span>
        </div>
      </div>
    </div>
    
    <!-- Back button moved outside the card -->
    <div class="actions">
      <a href="/main/" class="button-link">Back</a>
    </div>
  </main>

  <script>
    (function() {
      // WiFi signal strength mapping
      function getWifiIcon(rssi) {
        if (rssi >= -50) return '/assets/wifi3.svg';
        if (rssi >= -60) return '/assets/wifi2.svg'; 
        if (rssi >= -70) return '/assets/wifi1.svg';
        return '/assets/wifi0.svg';
      }

      // Format security type
      function formatAuth(auth) {
        switch (auth) {
          case 0: return 'Open';
          case 1: return 'WEP';
          case 2: return 'WPA';
          case 3: return 'WPA2';
          case 4: return 'WPA/WPA2';
          default: return 'Secured';
        }
      }

      // Create network item HTML
      function createNetworkItem(network, isClickable = true) {
        const icon = getWifiIcon(network.rssi);
        const security = network.auth > 0 ? 'ðŸ”’' : '';
        const clickableClass = isClickable ? 'clickable' : '';
        
        return `
          <div class="network-item ${clickableClass}" data-ssid="${network.ssid}" data-auth="${network.auth}">
            <img src="${icon}" alt="WiFi" class="wifi-icon">
            <div class="network-info">
              <span class="network-name">${network.ssid}</span>
              <span class="network-security">${security} ${formatAuth(network.auth)}</span>
            </div>
            <span class="network-signal">${network.rssi} dBm</span>
          </div>
        `;
      }

      // Display networks
      function displayNetworks(networks) {
        const scanStatus = document.getElementById('scan-status');
        const networksList = document.getElementById('networks-list');
        
        if (!networksList) return;

        if (networks.length === 0) {
          if (scanStatus) {
            scanStatus.textContent = 'No networks found';
          }
          return;
        }

        if (scanStatus) {
          scanStatus.style.display = 'none';
        }

        networks.sort((a, b) => b.rssi - a.rssi);
        networksList.innerHTML = networks.map(network => createNetworkItem(network, true)).join('');
        networksList.style.display = 'block';
      }

      // Load WiFi networks from server with timeout protection
      let pollAttempts = 0;
      const MAX_POLL_ATTEMPTS = 30; // Maximum 60 seconds of polling (30 * 2s)
      
      function loadWifiNetworks() {
        console.log('Loading WiFi networks from /api/wifi_networks, attempt:', pollAttempts + 1);
        fetch('/api/wifi_networks', {
          method: 'GET',
          credentials: 'include'
        })
        .then(response => {
          console.log('Response status:', response.status);
          console.log('Response headers:', [...response.headers.entries()]);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log('Received data:', data);
          
          if (data.status === 'ok') {
            if (data.scanning) {
              // Still scanning, check again in 2 seconds with timeout protection
              pollAttempts++;
              if (pollAttempts < MAX_POLL_ATTEMPTS) {
                console.log('Still scanning, checking again in 2 seconds (attempt ' + pollAttempts + '/' + MAX_POLL_ATTEMPTS + ')');
                document.getElementById('scan-status').textContent = 'Scanning... (' + pollAttempts + '/' + MAX_POLL_ATTEMPTS + ')';
                setTimeout(loadWifiNetworks, 2000);
              } else {
                console.error('Polling timeout reached, stopping');
                document.getElementById('scan-status').innerHTML = 'Scan timeout. <button id="retry-btn" style="margin-top: 10px; padding: 5px 10px;">Retry</button>';
                const retryBtn = document.getElementById('retry-btn');
                if (retryBtn) {
                  retryBtn.addEventListener('click', () => {
                    pollAttempts = 0; // Reset counter
                    loadWifiNetworks();
                  });
                }
              }
            } else {
              // Scan completed, display networks
              pollAttempts = 0; // Reset counter for next scan
              console.log('Scan completed, displaying networks:', data.networks);
              displayNetworks(data.networks || []);
            }
          } else {
            console.error('API returned error status:', data);
            document.getElementById('scan-status').textContent = 'Server error: ' + (data.code || 'unknown');
          }
        })
        .catch(error => {
          console.error('Network loading error:', error);
          const scanStatus = document.getElementById('scan-status');
          if (scanStatus) {
            scanStatus.innerHTML = `Failed to load networks: ${error.message}<br><button id="retry-btn" style="margin-top: 10px; padding: 5px 10px;">Retry</button>`;
            // Add retry button handler
            const retryBtn = document.getElementById('retry-btn');
            if (retryBtn) {
              retryBtn.addEventListener('click', () => {
                pollAttempts = 0; // Reset polling counter
                loadWifiNetworks();
              });
            }
          }
        });
      }

      // Initialize page
      function initWifiPage() {
        console.log('Initializing WiFi page');
        
        // Start checking for WiFi networks immediately
        loadWifiNetworks();

        // Add network button (now styled as list item)
        const addNetworkBtn = document.getElementById('add-network-btn');
        if (addNetworkBtn) {
          addNetworkBtn.addEventListener('click', () => {
            alert('Add network functionality coming soon');
          });
        }
      }

      // Initialize when DOM is ready
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initWifiPage);
      } else {
        initWifiPage();
      }
    })();
  </script>
</body>
</html>
